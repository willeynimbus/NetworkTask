name: Deploy Multi-Account Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  HUB_STACK_NAME: hub-infrastructure
  STACKSET_NAME: spoke-vpc-stackset

jobs:
  deploy-hub:
    name: Deploy Hub Infrastructure
    runs-on: ubuntu-latest
    outputs:
      transit-gateway-id: ${{ steps.hub-outputs.outputs.transit-gateway-id }}
      tgw-route-table-id: ${{ steps.hub-outputs.outputs.tgw-route-table-id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy Hub Infrastructure Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/hub/hub-infrastructure.yaml \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              SpokeAAccountId=${{ secrets.SPOKE_A_ACCOUNT_ID }} \
              SpokeBAccountId=${{ secrets.SPOKE_B_ACCOUNT_ID }}
      
      - name: Get Hub Stack Outputs
        id: hub-outputs
        run: |
          TRANSIT_GATEWAY_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayId`].OutputValue' \
            --output text)
          
          TGW_ROUTE_TABLE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayRouteTableId`].OutputValue' \
            --output text)
          
          echo "transit-gateway-id=$TRANSIT_GATEWAY_ID" >> $GITHUB_OUTPUT
          echo "tgw-route-table-id=$TGW_ROUTE_TABLE_ID" >> $GITHUB_OUTPUT
      
      - name: Display Hub Deployment Summary
        run: |
          echo "✅ Hub Infrastructure Deployed Successfully"
          echo "Transit Gateway ID: ${{ steps.hub-outputs.outputs.transit-gateway-id }}"
          echo "TGW Route Table ID: ${{ steps.hub-outputs.outputs.tgw-route-table-id }}"

  verify-ram-share:
    name: Verify RAM Share Acceptance
    runs-on: ubuntu-latest
    needs: deploy-hub
    outputs:
      ram-accepted: ${{ steps.check-acceptance.outputs.accepted }}
    
    steps:
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check RAM Share Status
        id: check-acceptance
        run: |
          echo "Checking RAM resource share status..."
          
          # Get all resource shares
          RESOURCE_SHARES=$(aws ram get-resource-shares \
            --resource-owner SELF \
            --query 'resourceShares[?name==`Hub-TGW-Account-Share`].resourceShareArn' \
            --output text)
          
          if [ -z "$RESOURCE_SHARES" ]; then
            echo "⚠️ No RAM resource share found. This might be expected if not using organization sharing."
            echo "accepted=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Resource Share ARN: $RESOURCE_SHARES"
          
          # Check if invitations are accepted for both spoke accounts
          SPOKE_A_ID="${{ secrets.SPOKE_A_ACCOUNT_ID }}"
          SPOKE_B_ID="${{ secrets.SPOKE_B_ACCOUNT_ID }}"
          
          ALL_ACCEPTED=true
          
          for ACCOUNT_ID in $SPOKE_A_ID $SPOKE_B_ID; do
            echo "Checking acceptance status for account: $ACCOUNT_ID"
            
            # Check if the principal (account) has accepted the share
            STATUS=$(aws ram get-resource-share-associations \
              --association-type PRINCIPAL \
              --resource-share-arns $RESOURCE_SHARES \
              --query "resourceShareAssociations[?associatedEntity=='$ACCOUNT_ID'].status" \
              --output text)
            
            if [ "$STATUS" == "ASSOCIATED" ]; then
              echo "✅ Account $ACCOUNT_ID has accepted the RAM share"
            else
              echo "⚠️ Account $ACCOUNT_ID status: $STATUS (Expected: ASSOCIATED)"
              ALL_ACCEPTED=false
            fi
          done
          
          if [ "$ALL_ACCEPTED" == "true" ]; then
            echo "✅ All spoke accounts have accepted the RAM share"
            echo "accepted=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Not all spoke accounts have accepted the RAM share"
            echo "Please accept the RAM share invitation in the spoke accounts"
            echo "accepted=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  deploy-spoke-stackset:
    name: Deploy Spoke VPC StackSet
    runs-on: ubuntu-latest
    needs: [deploy-hub, verify-ram-share]
    if: needs.verify-ram-share.outputs.ram-accepted == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create or Update StackSet
        run: |
          TRANSIT_GATEWAY_ID="${{ needs.deploy-hub.outputs.transit-gateway-id }}"
          
          # Check if StackSet exists
          if aws cloudformation describe-stack-set \
            --stack-set-name ${{ env.STACKSET_NAME }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null; then
            
            echo "StackSet exists. Updating..."
            aws cloudformation update-stack-set \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --template-body file://cloudformation/spoke/vpc.yaml \
              --capabilities CAPABILITY_IAM \
              --region ${{ env.AWS_REGION }} \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=2
            
            echo "✅ StackSet updated"
          else
            echo "StackSet does not exist. Creating..."
            aws cloudformation create-stack-set \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --template-body file://cloudformation/spoke/vpc.yaml \
              --capabilities CAPABILITY_IAM \
              --region ${{ env.AWS_REGION }}
            
            echo "✅ StackSet created"
          fi

  deploy-spoke-instances:
    name: Deploy to ${{ matrix.spoke.name }}
    runs-on: ubuntu-latest
    needs: [deploy-hub, verify-ram-share, deploy-spoke-stackset]
    if: needs.verify-ram-share.outputs.ram-accepted == 'true'
    strategy:
      fail-fast: false
      matrix:
        spoke:
          - name: SpokeA
            account_secret: SPOKE_A_ACCOUNT_ID
            vpc_cidr: 10.1.0.0/16
            public_subnet: 10.1.1.0/24
            private_subnet: 10.1.2.0/24
            other_spoke_cidr: 10.2.0.0/16
          - name: SpokeB
            account_secret: SPOKE_B_ACCOUNT_ID
            vpc_cidr: 10.2.0.0/16
            public_subnet: 10.2.1.0/24
            private_subnet: 10.2.2.0/24
            other_spoke_cidr: 10.1.0.0/16
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set Account ID
        id: account
        run: |
          if [ "${{ matrix.spoke.account_secret }}" == "SPOKE_A_ACCOUNT_ID" ]; then
            echo "account_id=${{ secrets.SPOKE_A_ACCOUNT_ID }}" >> $GITHUB_OUTPUT
          else
            echo "account_id=${{ secrets.SPOKE_B_ACCOUNT_ID }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy Stack Instance to ${{ matrix.spoke.name }}
        run: |
          TRANSIT_GATEWAY_ID="${{ needs.deploy-hub.outputs.transit-gateway-id }}"
          ACCOUNT_ID="${{ steps.account.outputs.account_id }}"
          
          echo "Deploying to ${{ matrix.spoke.name }} (Account: $ACCOUNT_ID)..."
          
          # Try to create stack instance
          aws cloudformation create-stack-instances \
            --stack-set-name ${{ env.STACKSET_NAME }} \
            --accounts $ACCOUNT_ID \
            --regions ${{ env.AWS_REGION }} \
            --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1 \
            --parameter-overrides \
              ParameterKey=EnvironmentName,ParameterValue=${{ matrix.spoke.name }} \
              ParameterKey=VpcCIDR,ParameterValue=${{ matrix.spoke.vpc_cidr }} \
              ParameterKey=PublicSubnetCIDR,ParameterValue=${{ matrix.spoke.public_subnet }} \
              ParameterKey=PrivateSubnetCIDR,ParameterValue=${{ matrix.spoke.private_subnet }} \
              ParameterKey=TransitGatewayId,ParameterValue=$TRANSIT_GATEWAY_ID \
              ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
              ParameterKey=OtherSpokeCIDRs,ParameterValue=${{ matrix.spoke.other_spoke_cidr }} \
            && echo "✅ Stack instance created for ${{ matrix.spoke.name }}" \
            || {
              echo "Stack instance might already exist. Checking status..."
              
              # Check if instance exists and get its status
              STATUS=$(aws cloudformation describe-stack-instance \
                --stack-set-name ${{ env.STACKSET_NAME }} \
                --stack-instance-account $ACCOUNT_ID \
                --stack-instance-region ${{ env.AWS_REGION }} \
                --query 'StackInstance.Status' \
                --output text 2>/dev/null || echo "NOT_FOUND")
              
              if [ "$STATUS" == "CURRENT" ]; then
                echo "✅ Stack instance already exists and is current"
              elif [ "$STATUS" == "NOT_FOUND" ]; then
                echo "❌ Failed to create stack instance and it doesn't exist"
                exit 1
              else
                echo "⚠️ Stack instance exists with status: $STATUS"
              fi
            }
      
      - name: Wait for Stack Instance Deployment
        run: |
          echo "Waiting for stack instance deployment to complete..."
          ACCOUNT_ID="${{ steps.account.outputs.account_id }}"
          
          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=15
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws cloudformation describe-stack-instance \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --stack-instance-account $ACCOUNT_ID \
              --stack-instance-region ${{ env.AWS_REGION }} \
              --query 'StackInstance.Status' \
              --output text 2>/dev/null || echo "NOT_FOUND")
            
            echo "Stack instance status: $STATUS"
            
            if [ "$STATUS" == "CURRENT" ]; then
              echo "✅ Stack instance deployment completed successfully"
              break
            elif [ "$STATUS" == "OUTDATED" ] || [ "$STATUS" == "INOPERABLE" ]; then
              echo "❌ Stack instance deployment failed with status: $STATUS"
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "⚠️ Timeout waiting for stack instance deployment"
            exit 1
          fi
      
      - name: Display Deployment Summary for ${{ matrix.spoke.name }}
        run: |
          echo "✅ ${{ matrix.spoke.name }} VPC Deployment Complete"
          echo ""
          echo "Account: ${{ matrix.spoke.account_id }}"
          echo "VPC CIDR: ${{ matrix.spoke.vpc_cidr }}"
          echo "Public Subnet: ${{ matrix.spoke.public_subnet }}"
          echo "Private Subnet: ${{ matrix.spoke.private_subnet }}"
