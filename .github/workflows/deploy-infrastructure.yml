name: Deploy Multi-Account Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  HUB_STACK_NAME: hub-infrastructure
  STACKSET_NAME: spoke-vpc-stackset

jobs:
  deploy-hub:
    name: Deploy Hub Infrastructure
    runs-on: ubuntu-latest
    outputs:
      transit-gateway-id: ${{ steps.hub-outputs.outputs.transit-gateway-id }}
      tgw-route-table-id: ${{ steps.hub-outputs.outputs.tgw-route-table-id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy Hub Infrastructure Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/hub/hub-infrastructure.yaml \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              SpokeAAccountId=${{ secrets.SPOKE_A_ACCOUNT_ID }} \
              SpokeBAccountId=${{ secrets.SPOKE_B_ACCOUNT_ID }}
      
      - name: Get Hub Stack Outputs
        id: hub-outputs
        run: |
          TRANSIT_GATEWAY_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayId`].OutputValue' \
            --output text)
          
          TGW_ROUTE_TABLE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayRouteTableId`].OutputValue' \
            --output text)
          
          echo "transit-gateway-id=$TRANSIT_GATEWAY_ID" >> $GITHUB_OUTPUT
          echo "tgw-route-table-id=$TGW_ROUTE_TABLE_ID" >> $GITHUB_OUTPUT
      
      - name: Display Hub Deployment Summary
        run: |
          echo "✅ Hub Infrastructure Deployed Successfully"
          echo "Transit Gateway ID: ${{ steps.hub-outputs.outputs.transit-gateway-id }}"
          echo "TGW Route Table ID: ${{ steps.hub-outputs.outputs.tgw-route-table-id }}"

  verify-ram-share:
    name: Verify RAM Share Acceptance
    runs-on: ubuntu-latest
    needs: deploy-hub
    outputs:
      ram-accepted: ${{ steps.check-acceptance.outputs.accepted }}
    
    steps:
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check RAM Share Status
        id: check-acceptance
        run: |
          echo "Checking RAM resource share status..."
          
          # Get all resource shares
          RESOURCE_SHARES=$(aws ram get-resource-shares \
            --resource-owner SELF \
            --query 'resourceShares[?name==`Hub-TGW-Account-Share`].resourceShareArn' \
            --output text)
          
          if [ -z "$RESOURCE_SHARES" ]; then
            echo "⚠️ No RAM resource share found. This might be expected if not using organization sharing."
            echo "accepted=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Resource Share ARN: $RESOURCE_SHARES"
          
          # Check if invitations are accepted for both spoke accounts
          SPOKE_A_ID="${{ secrets.SPOKE_A_ACCOUNT_ID }}"
          SPOKE_B_ID="${{ secrets.SPOKE_B_ACCOUNT_ID }}"
          
          ALL_ACCEPTED=true
          
          for ACCOUNT_ID in $SPOKE_A_ID $SPOKE_B_ID; do
            echo "Checking acceptance status for account: $ACCOUNT_ID"
            
            # Check if the principal (account) has accepted the share
            STATUS=$(aws ram get-resource-share-associations \
              --association-type PRINCIPAL \
              --resource-share-arns $RESOURCE_SHARES \
              --query "resourceShareAssociations[?associatedEntity=='$ACCOUNT_ID'].status" \
              --output text)
            
            if [ "$STATUS" == "ASSOCIATED" ]; then
              echo "✅ Account $ACCOUNT_ID has accepted the RAM share"
            else
              echo "⚠️ Account $ACCOUNT_ID status: $STATUS (Expected: ASSOCIATED)"
              ALL_ACCEPTED=false
            fi
          done
          
          if [ "$ALL_ACCEPTED" == "true" ]; then
            echo "✅ All spoke accounts have accepted the RAM share"
            echo "accepted=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Not all spoke accounts have accepted the RAM share"
            echo "Please accept the RAM share invitation in the spoke accounts"
            echo "accepted=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  deploy-spoke-stackset:
    name: Deploy Spoke VPC StackSet
    runs-on: ubuntu-latest
    needs: [deploy-hub, verify-ram-share]
    if: needs.verify-ram-share.outputs.ram-accepted == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create or Update StackSet
        run: |
          TRANSIT_GATEWAY_ID="${{ needs.deploy-hub.outputs.transit-gateway-id }}"
          
          # Check if StackSet exists
          if aws cloudformation describe-stack-set \
            --stack-set-name ${{ env.STACKSET_NAME }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null; then
            
            echo "StackSet exists. Updating..."
            aws cloudformation update-stack-set \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --template-body file://cloudformation/spoke/vpc.yaml \
              --capabilities CAPABILITY_IAM \
              --region ${{ env.AWS_REGION }} \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=2
            
            echo "✅ StackSet updated"
          else
            echo "StackSet does not exist. Creating..."
            aws cloudformation create-stack-set \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --template-body file://cloudformation/spoke/vpc.yaml \
              --capabilities CAPABILITY_IAM \
              --region ${{ env.AWS_REGION }}
            
            echo "✅ StackSet created"
          fi

  deploy-spoke-instances:
    name: Deploy Spoke VPC Instances
    runs-on: ubuntu-latest
    needs: [deploy-hub, verify-ram-share, deploy-spoke-stackset]
    if: needs.verify-ram-share.outputs.ram-accepted == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy Stack Instances to Both Spoke Accounts (Parallel)
        id: deploy
        run: |
          TRANSIT_GATEWAY_ID="${{ needs.deploy-hub.outputs.transit-gateway-id }}"
          SPOKE_A_ID="${{ secrets.SPOKE_A_ACCOUNT_ID }}"
          SPOKE_B_ID="${{ secrets.SPOKE_B_ACCOUNT_ID }}"
          
          echo "Deploying to both spoke accounts in parallel..."
          echo "Spoke A: $SPOKE_A_ID (10.1.0.0/16)"
          echo "Spoke B: $SPOKE_B_ID (10.2.0.0/16)"
          
          # Deploy to both accounts with deployment targets
          # Note: We'll use two separate operations since parameters differ per account
          
          # Deploy to Spoke A
          echo "Starting deployment to Spoke A..."
          OPERATION_A=$(aws cloudformation create-stack-instances \
            --stack-set-name ${{ env.STACKSET_NAME }} \
            --accounts $SPOKE_A_ID \
            --regions ${{ env.AWS_REGION }} \
            --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=2 \
            --parameter-overrides \
              ParameterKey=EnvironmentName,ParameterValue=SpokeA \
              ParameterKey=VpcCIDR,ParameterValue=10.1.0.0/16 \
              ParameterKey=PublicSubnetCIDR,ParameterValue=10.1.1.0/24 \
              ParameterKey=PrivateSubnetCIDR,ParameterValue=10.1.2.0/24 \
              ParameterKey=TransitGatewayId,ParameterValue=$TRANSIT_GATEWAY_ID \
              ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
              ParameterKey=OtherSpokeCIDRs,ParameterValue=10.2.0.0/16 \
            --query 'OperationId' \
            --output text 2>&1) || {
              echo "Spoke A might already exist, checking status..."
              OPERATION_A="SKIPPED"
            }
          
          echo "Spoke A Operation ID: $OPERATION_A"
          
          # Wait a moment before starting second operation
          sleep 5
          
          # Deploy to Spoke B
          echo "Starting deployment to Spoke B..."
          OPERATION_B=$(aws cloudformation create-stack-instances \
            --stack-set-name ${{ env.STACKSET_NAME }} \
            --accounts $SPOKE_B_ID \
            --regions ${{ env.AWS_REGION }} \
            --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=2 \
            --parameter-overrides \
              ParameterKey=EnvironmentName,ParameterValue=SpokeB \
              ParameterKey=VpcCIDR,ParameterValue=10.2.0.0/16 \
              ParameterKey=PublicSubnetCIDR,ParameterValue=10.2.1.0/24 \
              ParameterKey=PrivateSubnetCIDR,ParameterValue=10.2.2.0/24 \
              ParameterKey=TransitGatewayId,ParameterValue=$TRANSIT_GATEWAY_ID \
              ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
              ParameterKey=OtherSpokeCIDRs,ParameterValue=10.1.0.0/16 \
            --query 'OperationId' \
            --output text 2>&1) || {
              echo "Spoke B might already exist, checking status..."
              OPERATION_B="SKIPPED"
            }
          
          echo "Spoke B Operation ID: $OPERATION_B"
          
          echo "operation_a=$OPERATION_A" >> $GITHUB_OUTPUT
          echo "operation_b=$OPERATION_B" >> $GITHUB_OUTPUT
      
      - name: Wait for Deployments to Complete
        run: |
          OPERATION_A="${{ steps.deploy.outputs.operation_a }}"
          OPERATION_B="${{ steps.deploy.outputs.operation_b }}"
          
          echo "Waiting for both deployments to complete..."
          echo "Operation A: $OPERATION_A"
          echo "Operation B: $OPERATION_B"
          
          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=20
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            ALL_DONE=true
            
            # Check Spoke A
            if [ "$OPERATION_A" != "SKIPPED" ]; then
              STATUS_A=$(aws cloudformation describe-stack-set-operation \
                --stack-set-name ${{ env.STACKSET_NAME }} \
                --operation-id $OPERATION_A \
                --query 'StackSetOperation.Status' \
                --output text 2>/dev/null || echo "UNKNOWN")
              
              echo "Spoke A status: $STATUS_A"
              
              if [ "$STATUS_A" == "RUNNING" ]; then
                ALL_DONE=false
              elif [ "$STATUS_A" == "FAILED" ] || [ "$STATUS_A" == "STOPPED" ]; then
                echo "❌ Spoke A deployment failed"
                exit 1
              fi
            fi
            
            # Check Spoke B
            if [ "$OPERATION_B" != "SKIPPED" ]; then
              STATUS_B=$(aws cloudformation describe-stack-set-operation \
                --stack-set-name ${{ env.STACKSET_NAME }} \
                --operation-id $OPERATION_B \
                --query 'StackSetOperation.Status' \
                --output text 2>/dev/null || echo "UNKNOWN")
              
              echo "Spoke B status: $STATUS_B"
              
              if [ "$STATUS_B" == "RUNNING" ]; then
                ALL_DONE=false
              elif [ "$STATUS_B" == "FAILED" ] || [ "$STATUS_B" == "STOPPED" ]; then
                echo "❌ Spoke B deployment failed"
                exit 1
              fi
            fi
            
            if [ "$ALL_DONE" == "true" ]; then
              echo "✅ All deployments completed successfully"
              break
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "⚠️ Timeout waiting for deployments"
            exit 1
          fi
      
      - name: Display Deployment Summary
        run: |
          echo "✅ Spoke VPC Deployments Complete"
          echo ""
          echo "Deployed to accounts:"
          echo "  - Spoke A: ${{ secrets.SPOKE_A_ACCOUNT_ID }} (10.1.0.0/16)"
          echo "  - Spoke B: ${{ secrets.SPOKE_B_ACCOUNT_ID }} (10.2.0.0/16)"
          echo ""
          echo "Both spokes deployed in parallel via StackSet!"
