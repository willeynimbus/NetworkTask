name: Deploy Multi-Account Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  HUB_STACK_NAME: hub-infrastructure
  STACKSET_NAME: spoke-vpc-stackset

jobs:
  deploy-hub:
    name: Deploy Hub Infrastructure
    runs-on: ubuntu-latest
    outputs:
      transit-gateway-id: ${{ steps.hub-outputs.outputs.transit-gateway-id }}
      tgw-route-table-id: ${{ steps.hub-outputs.outputs.tgw-route-table-id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy Hub Infrastructure Stack
        run: |
          aws cloudformation deploy \
            --template-file cloudformation/hub/hub-infrastructure.yaml \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              SpokeAAccountId=${{ secrets.SPOKE_A_ACCOUNT_ID }} \
              SpokeBAccountId=${{ secrets.SPOKE_B_ACCOUNT_ID }}
      
      - name: Get Hub Stack Outputs
        id: hub-outputs
        run: |
          TRANSIT_GATEWAY_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayId`].OutputValue' \
            --output text)
          
          TGW_ROUTE_TABLE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.HUB_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayRouteTableId`].OutputValue' \
            --output text)
          
          echo "transit-gateway-id=$TRANSIT_GATEWAY_ID" >> $GITHUB_OUTPUT
          echo "tgw-route-table-id=$TGW_ROUTE_TABLE_ID" >> $GITHUB_OUTPUT
      
      - name: Display Hub Deployment Summary
        run: |
          echo "✅ Hub Infrastructure Deployed Successfully"
          echo "Transit Gateway ID: ${{ steps.hub-outputs.outputs.transit-gateway-id }}"
          echo "TGW Route Table ID: ${{ steps.hub-outputs.outputs.tgw-route-table-id }}"

  verify-ram-share:
    name: Verify RAM Share Acceptance
    runs-on: ubuntu-latest
    needs: deploy-hub
    outputs:
      ram-accepted: ${{ steps.check-acceptance.outputs.accepted }}
    
    steps:
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check RAM Share Status
        id: check-acceptance
        run: |
          echo "Checking RAM resource share status..."
          
          # Get all resource shares
          RESOURCE_SHARES=$(aws ram get-resource-shares \
            --resource-owner SELF \
            --query 'resourceShares[?name==`Hub-TGW-Account-Share`].resourceShareArn' \
            --output text)
          
          if [ -z "$RESOURCE_SHARES" ]; then
            echo "⚠️ No RAM resource share found. This might be expected if not using organization sharing."
            echo "accepted=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Resource Share ARN: $RESOURCE_SHARES"
          
          # Check if invitations are accepted for both spoke accounts
          SPOKE_A_ID="${{ secrets.SPOKE_A_ACCOUNT_ID }}"
          SPOKE_B_ID="${{ secrets.SPOKE_B_ACCOUNT_ID }}"
          
          ALL_ACCEPTED=true
          
          for ACCOUNT_ID in $SPOKE_A_ID $SPOKE_B_ID; do
            echo "Checking acceptance status for account: $ACCOUNT_ID"
            
            # Check if the principal (account) has accepted the share
            STATUS=$(aws ram get-resource-share-associations \
              --association-type PRINCIPAL \
              --resource-share-arns $RESOURCE_SHARES \
              --query "resourceShareAssociations[?associatedEntity=='$ACCOUNT_ID'].status" \
              --output text)
            
            if [ "$STATUS" == "ASSOCIATED" ]; then
              echo "✅ Account $ACCOUNT_ID has accepted the RAM share"
            else
              echo "⚠️ Account $ACCOUNT_ID status: $STATUS (Expected: ASSOCIATED)"
              ALL_ACCEPTED=false
            fi
          done
          
          if [ "$ALL_ACCEPTED" == "true" ]; then
            echo "✅ All spoke accounts have accepted the RAM share"
            echo "accepted=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Not all spoke accounts have accepted the RAM share"
            echo "Please accept the RAM share invitation in the spoke accounts"
            echo "accepted=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  deploy-spoke-stackset:
    name: Deploy Spoke VPC StackSet
    runs-on: ubuntu-latest
    needs: [deploy-hub, verify-ram-share]
    if: needs.verify-ram-share.outputs.ram-accepted == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create or Update StackSet
        run: |
          TRANSIT_GATEWAY_ID="${{ needs.deploy-hub.outputs.transit-gateway-id }}"
          
          # Check if StackSet exists
          if aws cloudformation describe-stack-set \
            --stack-set-name ${{ env.STACKSET_NAME }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null; then
            
            echo "StackSet exists. Updating..."
            aws cloudformation update-stack-set \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --template-body file://cloudformation/spoke/vpc.yaml \
              --capabilities CAPABILITY_IAM \
              --region ${{ env.AWS_REGION }} \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=2
            
            echo "✅ StackSet updated"
          else
            echo "StackSet does not exist. Creating..."
            aws cloudformation create-stack-set \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --template-body file://cloudformation/spoke/vpc.yaml \
              --capabilities CAPABILITY_IAM \
              --region ${{ env.AWS_REGION }}
            
            echo "✅ StackSet created"
          fi

  deploy-spoke-instances:
    name: Deploy Spoke VPC Instances
    runs-on: ubuntu-latest
    needs: [deploy-hub, verify-ram-share, deploy-spoke-stackset]
    if: needs.verify-ram-share.outputs.ram-accepted == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials for Hub Account
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy Stack Instances to Both Spoke Accounts (Parallel)
        id: deploy
        run: |
          TRANSIT_GATEWAY_ID="${{ needs.deploy-hub.outputs.transit-gateway-id }}"
          SPOKE_A_ID="${{ secrets.SPOKE_A_ACCOUNT_ID }}"
          SPOKE_B_ID="${{ secrets.SPOKE_B_ACCOUNT_ID }}"
          
          echo "Deploying to both spoke accounts in parallel..."
          echo "Spoke A: $SPOKE_A_ID"
          echo "Spoke B: $SPOKE_B_ID"
          echo ""
          echo "Note: CIDR values are configured via mappings in the template"
          echo "  - Spoke A: 10.1.0.0/16"
          echo "  - Spoke B: 10.2.0.0/16"
          echo ""
          
          # Check if instances already exist
          EXISTING_INSTANCES=$(aws cloudformation list-stack-instances \
            --stack-set-name ${{ env.STACKSET_NAME }} \
            --query 'Summaries[].Account' \
            --output text 2>/dev/null || echo "")
          
          if echo "$EXISTING_INSTANCES" | grep -q "$SPOKE_A_ID\|$SPOKE_B_ID"; then
            echo "Stack instances exist. Updating..."
            OPERATION_ID=$(aws cloudformation update-stack-instances \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --accounts $SPOKE_A_ID $SPOKE_B_ID \
              --regions ${{ env.AWS_REGION }} \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=2 \
              --parameter-overrides \
                ParameterKey=TransitGatewayId,ParameterValue=$TRANSIT_GATEWAY_ID \
                ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
              --query 'OperationId' \
              --output text)
            echo "Update operation started: $OPERATION_ID"
          else
            echo "Creating new stack instances..."
            OPERATION_ID=$(aws cloudformation create-stack-instances \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --accounts $SPOKE_A_ID $SPOKE_B_ID \
              --regions ${{ env.AWS_REGION }} \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=2 \
              --parameter-overrides \
                ParameterKey=TransitGatewayId,ParameterValue=$TRANSIT_GATEWAY_ID \
                ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
              --query 'OperationId' \
              --output text)
            echo "Create operation started: $OPERATION_ID"
          fi
          
          # Wait for parallel deployment to complete
          echo ""
          echo "Waiting for parallel deployment to complete..."
          MAX_WAIT=600
          ELAPSED=0
          INTERVAL=15
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws cloudformation describe-stack-set-operation \
              --stack-set-name ${{ env.STACKSET_NAME }} \
              --operation-id $OPERATION_ID \
              --query 'StackSetOperation.Status' \
              --output text 2>/dev/null || echo "UNKNOWN")
            
            echo "Operation status: $STATUS (elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" == "SUCCEEDED" ]; then
              echo ""
              echo "✅ Parallel deployment completed successfully"
              break
            elif [ "$STATUS" == "FAILED" ] || [ "$STATUS" == "STOPPED" ]; then
              echo ""
              echo "❌ Deployment failed"
              
              # Show detailed error information
              echo "Fetching error details..."
              aws cloudformation describe-stack-set-operation \
                --stack-set-name ${{ env.STACKSET_NAME }} \
                --operation-id $OPERATION_ID \
                --query 'StackSetOperation.{Status:Status,StatusReason:StatusReason}' \
                --output table
              
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo ""
            echo "⚠️ Timeout waiting for deployment"
            exit 1
          fi
          
          echo "deployment_complete=true" >> $GITHUB_OUTPUT
      
      - name: Display Deployment Summary
        run: |
          echo "✅ Spoke VPC Deployments Complete"
          echo ""
          echo "Deployed to accounts:"
          echo "  - Spoke A: ${{ secrets.SPOKE_A_ACCOUNT_ID }} (10.1.0.0/16)"
          echo "  - Spoke B: ${{ secrets.SPOKE_B_ACCOUNT_ID }} (10.2.0.0/16)"
          echo ""
          echo "Both spokes deployed in parallel via StackSet!"
          echo "CIDR configurations applied automatically via CloudFormation mappings."
